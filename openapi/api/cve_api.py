import json
import os
from typing import List

from fastapi import APIRouter, FastAPI

from openapi.domain.CVEProduct import CVEProduct

app = FastAPI()
router = APIRouter()


@router.get("/cvefor/{cpe}", response_model=List[CVEProduct])
async def cves_from_cpe(cpe: str) -> List[CVEProduct]:
    print(cpe)

    list_cves: List[CVEProduct] = []

    cmd = "../bin/search.py -a -p " + cpe + " -o json --only-if-vulnerable > ./output.json"
    os.system(cmd)

    with open("./output.json") as f:
        output = json.loads("[" + f.read().replace("}\n{", "},\n{") + "]")

    for o in output:
        cve = CVEProduct(**o)
        list_cves.append(cve)

    return list_cves
