from __future__ import annotations
from fastapi import FastAPI
from pydantic import BaseModel, Field
from typing import List, Optional
import os
import json

from openapi.domain.Access import Access
from openapi.domain.Exploitability3 import Exploitability3
from openapi.domain.Model import Model
from openapi.domain.Taxonomy import Taxonomy

app = FastAPI()

class _(BaseModel):
    Entry_ID: str
    Entry_Name: str
    URL: str

class OWASPAttacks(BaseModel):
    _:_


#@app.post("/cvesfromcpe", response_model=list[ProductCVE])
@app.get("/cvesfromcpe/{cpe}", response_model=List[Model])
async def cves_from_cpe(cpe: str) -> List[Model]:
    print(cpe)

    list_cves: List[Model] = []

    cmd = "../bin/search.py -a -p " + cpe +" -o json --only-if-vulnerable > ./output.json"
    os.system(cmd)

    with open("./output.json") as f:
        output = json.loads("[" + f.read().replace("}\n{", "},\n{") + "]")

    for o in output:
        cve = Model(**o)
        list_cves.append(cve)

    return list_cves

